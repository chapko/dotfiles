#!/usr/bin/env bash

set -e

if [[ $# -gt 0 ]]; then
    selected="$1"
else
    selected="$(find ~ ~/.config ~/workspace ~/workspace/rss ~/workspace/clones /etc -mindepth 1 -maxdepth 1 -type d | fzf)"
fi


if [[ -z "${selected}" ]]; then
    exit 0
fi

if [[ -f "${selected}" ]]; then
    "${EDITOR}" "${selected}"
    exit 0
fi

selected_name=$(basename "${selected}" | tr . _)
tmux_running=$(pgrep tmux || true)

if [[ -z "${tmux_running}" ]]; then
    tmux new-session -s "${selected_name}" -c "${selected}" "${EDITOR}"
    exit 0
fi

switch_cmd=$([[ -z "${TMUX}" ]] && echo "attach" || echo "switch-client")

if ! tmux has-session -t "${selected_name}" 2> /dev/null; then
    tmux new-session -ds "${selected_name}" -c "${selected}" "${EDITOR}"
    tmux "${switch_cmd}" -t "${selected_name}"
    exit 0
fi

nvim_pane=$(tmux list-panes -t "${selected_name}" -F '#{pane_id} #{pane_current_command}' | grep nvim)

if [[ -n "${nvim_pane}" ]]; then
    IFS=' ' read -ra parts <<< "${nvim_pane}"
    selected_name="${parts[0]}"
    tmux "${switch_cmd}" -t "${selected_name}"
    exit 0
fi

tmux "${switch_cmd}" -t "${selected_name}" \; split-window -c "${selected}" -vbf "${EDITOR}"
